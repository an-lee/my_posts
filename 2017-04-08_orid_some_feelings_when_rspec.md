---
title: ORID_写RSpec的一些体会
date: 2017-04-08 06:30
categories: fullstack
tags:
  - Rails
  - ORID
---

前几天一直在写 RSpec，一边写一边发现自己原来写的 controller 有需要改善的地方，甚至有不少地方写错了，这个过程也对 TDD 的开发模式有了更深一点点的理解。

在写 TESTING 的时候，关键在于找到边界（edge）的情况，能够完整并且清晰地把网站的所有需求描述出来，根据这个来检验网站的 MVC 设计是否合理。

在过程中，我体会到一个细节，比较说明问题。当网站用户正常访问、正常操作的时候，网站功能完全正常，这样的情况其实是容易做到的。但是，如果用户操作不正确的时候，网站的反馈往往容易被忽略。

最常见的情况是，设置访客的权限，如果进入了非权限的网页，会被返回到登录页面。这个情况，由于用了 devise，已经不需要我们操心了。

而其他的权限呢，比如说，用户只能访问自己参加的群组页面。如果用户访问了非自己参加的其他群组时，网站应该给予什么反馈呢？

其实要视乎网站 View 层级的一些设置，如果在网页上有这个入口（可以视作网站对用户的一个引导），是用户点了这个入口，却进入了无权限的网页，那么在逻辑上，网站应该给予正确的引导， `redirect_to root_path`，同时要有 `flash[:alert] = "你无权访问，请先申请加入群组" `，让用户知道发生了什么事。否则用户可能会觉得莫名其妙。

比如说下面的代码：

```ruby
if current_user.is_member_of?(@group)
  @group = Group.find(params[:id])
else
  redirect_to root_path, alert: "你无权访问，请先申请加入群组"
end
```

但是如果网页上并没有这个入口（网站并没有对用户引导），而用户还是进入了无权限的网页，那么在逻辑上可以猜测这个用户的访问**可能是不怀好意**的。对于来者不善的用户，我们并不需要给 TA 任何提示，也不应该给任何提示，因为这样会让 TA 更容易猜到网站的内部逻辑，鬼知道 TA 接下来要做什么。所以，这个情况，我们只需要反馈一个错误页面就够了。比如说

```ruby
@group = current_user.joined_groups.find(params[:id])
```

这句代码的意思是，在当前用户所参加过的 groups 里找当前访问的这个 group，如果找不到，就只会提示错误。

以上的这些细节都是我在写 controller spec 的时候，罗列了各种情况之后才发现的。这在侧面反映了写 TESTING 的重要性，对每一个 edge 的思考和打磨，不光能提升用户体验，也能避免很多安全性的问题。

接下来的实作，都应该尽可能地使用 TDD 的开发模式。