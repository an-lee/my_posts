---
title: ORID_瘦C胖M
date: 2017-04-04 09:00
categories: fullstack
tags:
  - ORID
  - Rails
---

前天用 quick and dirty 的方法完成了一条题目，昨天花点时间「简单装修」了一下，测试了各项功能都正常，但总觉得哪里好像不太对劲。在网上搜了一些关于 Refactor 的文章。看到一条 pattern 叫

> Fat model, skinny controller.

字面的意思应该是，应该让控制器 controller 瘦身，少放一些代码，尽可能把代码放到模型 model 里去实现，让 model 显得胖一些。

再翻几页 google 就发现，这一条 pattern 也有很多人持反对意见。很多观点暂时看不太明白。

反观自己写得代码，明显就是「Skinny model, fat controller」。这样带来的一个实际问题就是，单元测试更困难。对 model 的单元测试显然更加简单明了，而 controller 的单元测试是比较少用的，全栈营的教程上更是直接建议以 feature spec 来替代 controller spec。

为了有效测试这一点，起码我应该把 controller 重构一下，把多余的东西搬到 model 里去。学习至今，对 MVC 的架构越来越熟了，昨天在网上还找到这样的总结，以一个交通体系的设计来类比一个程序设计。

> `router 路由`：是交通体系里的道标、路牌，用于指引方向。
>
> `model 模型`：是某一种交通规则，涵盖了这个情景下的各种约束与方案，不可被具体触摸的规则。
>
> `views 视图`：是道路、桥、高架、隧道、高速公路，是一切和你息息相关，可以被你感知和触摸到的很具体的物体。
>
> `controller 控制器`：是驱动力，驾驶员做出抉择，交通工具负责执行，交警负责裁决。他是链接有形与无形之间的纽带。

从这个类比出发，「Fat model, skinny controller」这条 pattern 就可以理解成，尽可能地为「驾驶员」减负，让「驾驶员」少做决定。规则性的逻辑应该交给 model 层级。

突然想到一个类比：如果我开车闯了红灯，按照交通规则，我应该扣分并且罚款。也就是「闯红灯」的动作应该触发「扣分」和「罚款」这两个事件。那「扣分」和「罚款」这两个动作应该由谁来完成呢？

惯例是，得由驾驶员**自己**拿着驾照和钱去交通局办理扣分和罚款，这样带来明显的问题就是**效率太低**了。驾驶员就应该好好开车，其他杂活应该交给别人来办理。谁来办呢？我认为最好的做法是，系统**自动扣分**和**自动扣款**。只要事前绑定好银行卡就好了嘛。扣完分、扣完款，只需要发个短信通知一下驾驶员。

如果想**测试**一下「闯红灯就扣分扣款」这条交通规则是否正常执行，驾驶员只需要闯一下红灯，然后看自己有没有收到短息提示，或者查一下自己的驾照有没有扣分、银行卡有没有扣款，就知道了。

再延伸一下，「闯红灯就扣分扣款」是非常明确的规则，属于非常简单的逻辑，可以让系统直接完成。但是另外一些复杂的违例可能就没那么明确了，比如说两辆车发生刮碰，责任一般不容易立即明确，需要有「交警」来根据实际情况来裁决。这样的逻辑就很难直接写到系统里去自动执行。

今天就接着 refactor 吧。